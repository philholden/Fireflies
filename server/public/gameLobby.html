<html>
  <head>
  <link rel="stylesheet" href="stylesheets/smoke.css" type="text/css" media="screen" />
  <script src="javascripts/smoke.min.js" type="text/javascript"></script>
  <script src="javascripts/util.js" type="text/javascript"></script>
  <script src="javascripts/underscore-min.js" type="text/javascript"></script>  
  <script src="javascripts/world.js" type="text/javascript"></script>
  <script src="javascripts/joystick.js" type="text/javascript"></script>
  <script src="javascripts/fly.js" type="text/javascript"></script>
  <script src="javascripts/fish.js" type="text/javascript"></script>
  <script src="javascripts/multiFlyGame.js" type="text/javascript"></script>
  <script src="javascripts/engine.js" type="text/javascript"></script>
  <script src="javascripts/keyboard.js" type="text/javascript"></script>
  <script src="javascripts/player.js" type="text/javascript"></script>
  <script src="javascripts/jquery-1.7.2.min.js" type="text/javascript"></script>
  <script src="javascripts/knockout-2.0.0.js" type="text/javascript"></script>
  <script type="text/javascript" src="socket.io/socket.io.js"></script>
  <script type="text/javascript" src="javascripts/gameChannel.js"></script>
  <script type="text/javascript" src="javascripts/renderer.js"></script>
  <script type="text/javascript" src="javascripts/lobbyViewModel.js"></script>
  <script>
    requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||  
                        window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
    var en = new Engine();
    var kb = new Keyboard();
    var a=0;
    var man;
    var input;
    var st = Date.now();
    var man;
    var rd;
    var gc;
    var audio;
    var lobby;
    
    function loop(){
      input = $("input[type=text]");
      body = $("body");
      requestAnimationFrame(step);
      body.keyup(function(e){key(kb.keyUp(e.keyCode))});
      body.keydown(function(e){key(kb.keyDown(e.keyCode))});
    }
    
    function key(k){
      if(k && gc){
        gc.socket.json.send(keyEncode(k));
      }
    }
    
    function keyEncode(k){
      return k + en.me + ":" + en.frameId(); 
    }
    
    function keyDecode(c){
      var sp = c.split(':');
      return {
        e:c.charAt(0),
        id:sp.substr(1),
        f:sp[1]
      };
    }
    
    function step(timestamp) {
      if (rd) {
        rd.draw(en);
        en.render++;
      }
      if(en.go){
        requestAnimationFrame(step);
      }
    }
    
    $(window).load(function(){
      var w = new World();
      rd = new Renderer($('#game'),w);
      rd.init();
      audio = $('audio');
      audio.each(function(i,a){
        a.load();
      });
      setTimeout(function(){
        gc = new gameChannel()
      },500);
      lobby = new LobbyViewModel();
      ko.applyBindings(lobby);
    });

    
  </script>
  <style>
    .man {
      position: absolute;
      color: white;
    }
    canvas {display: block}
    audio {display: none}
    .selected {
      background: #ccc;
    }
    .users {
      list-style-type: none;
      padding-left: 0;
    }
    
    .users tr {
      cursor: default;
    }
    
    .users tr:hover {
      background: #ccc;
    }
    
    table, th, td
    {
      border-collapse:collapse;
      border-spacing: 0px;
      border:0px solid black;
    } 
    
    tr.me {
      font-weight: bold;
      background: orange;
    }
    
    .name {
      display: inline-block;
      width: 5em;
    }
    
    .score {
      display: inline-block;
    }
    
  </style>
  </head>
  <body tabindex="0">
    <input type="hidden" id="channel" value="physics" />
    <audio src="sound/hit4.ogg" controls></audio>
    <audio src="sound/drip3.ogg" controls></audio>
    <audio src="sound/drip2.ogg" controls></audio>
    <audio src="sound/lick.ogg" controls></audio>
    <audio src="sound/splash2.ogg" controls></audio>
    <div id="lobby" data-bind="visible: displayLobby">
      <p>Select players to challenge</p>
      <p>or click your player to edit name:</p>
      <!--<ul data-bind="foreach: availables" class="users">
        <li data-bind="click: $parent.addSelection, attr: {class : classes}">
          <div class="name" data-bind="text: name"></div>
          <div class="score" data-bind="text: score"></div>
        </li>
      </ul>-->
      <table>
        <tbody data-bind="foreach: availables" class="users">
   
        <tr data-bind="click: $parent.addSelection, attr: {class : classes}">
          <td class="name" data-bind="text: name, attr: {title : userTip}"></td>
          <td class="score" data-bind="text: score"></td>
        </tr>
      </ul>
        </tbody>
      </table>
      <button id="challenge" data-bind="click: sendChallenge,enable: challengeEnabled">Challenge</button>
    </div>
    <div id="challenge" data-bind="visible: displayChallenge">
      <p>You have been challenged:</p>
      <ul data-bind="foreach: myChallengers" class="users">
        <li data-bind="attr: {class : classes}">
          <div class="name" data-bind="text: name"></div>
          <div class="score" data-bind="text: score"></div>
        </li>
      </ul>
      <button data-bind="enable: meUndecided, click: accept">accept</button>
      <button data-bind="enable: meUndecided, click: decline">decline</button>
    </div>
    <div id="game" data-bind="visible: displayGame">
    </div>
  </body>
</html>